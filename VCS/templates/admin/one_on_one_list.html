{% extends 'base.html' %}
{% block content %}

<!-- Boxicons -->
<link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">

<div class="max-w-7xl mx-auto px-6 py-8">

    <!-- Back -->
    <a href="{% url 'admin_dashboard' %}"
       class="inline-flex items-center gap-2 text-sm font-medium text-slate-500 hover:text-slate-900 transition">
        <i class='bx bx-arrow-back'></i>
        Back to Dashboard
    </a>

    <!-- Header -->
    <div class="mt-6 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div>
            <h1 class="text-3xl font-bold tracking-tight text-slate-900">
                1-on-1 Sessions
            </h1>
            <p class="mt-1 text-slate-500">
                Schedule and manage personal mentoring sessions
            </p>
        </div>

        <button onclick="openCreateModal()"
                class="inline-flex items-center gap-2
                       bg-gradient-to-r from-emerald-600 to-teal-600
                       text-white px-6 py-3 rounded-xl font-semibold
                       shadow-lg hover:shadow-xl hover:scale-[1.02] transition">
            <i class='bx bx-user-plus text-xl'></i>
            Create Session
        </button>
    </div>

    <!-- Filters -->
    <div class="mt-8 flex flex-col lg:flex-row gap-4">
        <div class="relative w-full lg:w-1/3">
            <i class='bx bx-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-400'></i>
            <input id="searchInput" type="text"
                   placeholder="Search candidate..."
                   class="w-full pl-12 pr-4 py-3 rounded-xl border border-slate-200
                          focus:ring-2 focus:ring-emerald-500 shadow-sm">
        </div>

        <select id="statusFilter"
                class="w-full lg:w-1/4 px-4 py-3 rounded-xl border border-slate-200
                       focus:ring-2 focus:ring-emerald-500 shadow-sm">
            <option value="">All Status</option>
            <option value="SCHEDULED">Scheduled</option>
            <option value="DONE">Done</option>
            <option value="POSTPONED">Postponed</option>
        </select>

        <button id="clearFilters"
                class="inline-flex items-center gap-2 px-5 py-3 rounded-xl
                       bg-slate-100 hover:bg-slate-200 transition font-medium">
            <i class='bx bx-refresh'></i>
            Reset
        </button>
    </div>

    <!-- Table -->
    <div class="mt-8 overflow-hidden rounded-2xl border border-slate-200 bg-white shadow-xl">
        <table class="min-w-full">
            <thead class="bg-slate-50">
                <tr>
                    <th class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase">Candidate</th>
                    <th class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase">Date & Time</th>
                    <th class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase">Status</th>
                    <th class="px-6 py-4 text-right text-xs font-semibold text-slate-500 uppercase">Actions</th>
                </tr>
            </thead>

            <tbody id="appointmentTable" class="divide-y divide-slate-100">
            {% for appt in appointments %}
                <tr class="appointment-row hover:bg-slate-50 transition"
                    data-status="{{ appt.status }}">

                    <td class="px-6 py-4 font-medium text-slate-900">
                        {{ appt.application.user.username }}
                    </td>

                    <td class="px-6 py-4 text-slate-600">
                        {{ appt.scheduled_at }}
                    </td>

                    <td class="px-6 py-4">
                        {% if appt.status == 'SCHEDULED' %}
                        <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full
                                     bg-emerald-100 text-emerald-700 text-xs font-semibold">
                            <i class='bx bx-time'></i> Scheduled
                        </span>
                        {% elif appt.status == 'DONE' %}
                        <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full
                                     bg-blue-100 text-blue-700 text-xs font-semibold">
                            <i class='bx bx-check-circle'></i> Done
                        </span>
                        {% elif appt.status == 'POSTPONED' %}
                        <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full
                                     bg-yellow-100 text-yellow-700 text-xs font-semibold">
                            <i class='bx bx-pause-circle'></i> Postponed
                        </span>
                        {% endif %}
                    </td>

                    <td class="px-6 py-4 text-right space-x-4">
                        {% if appt.status != 'DONE' %}
                        <button onclick="openEditModal({{ appt.id }})"
                                class="text-blue-600 hover:text-blue-800 font-medium">
                            Edit
                        </button>
                        <button onclick="openPostponeModal({{ appt.id }})"
                                class="text-yellow-600 hover:text-yellow-800 font-medium">
                            Postpone
                        </button>
                        <button onclick="markAsDone({{ appt.id }})"
                                class="text-emerald-600 hover:text-emerald-800 font-medium">
                            Done
                        </button>
                        {% endif %}
                        {% if appt.status == 'DONE' %}
                        <button onclick="openViewModal({{ appt.id }})"
                                class="text-gray-600 hover:text-gray-800 font-medium">
                            View
                        </button>
                        {% endif %}
                    </td>
                </tr>
            {% empty %}
                <tr>
                    <td colspan="4" class="px-6 py-10 text-center text-slate-500">
                        No 1-on-1 sessions found
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Modal -->
<div id="appointmentModal"
     class="hidden fixed inset-0 bg-black/40 backdrop-blur-sm z-50
            flex items-center justify-center">

    <div class="bg-white w-full max-w-lg mx-4 rounded-2xl shadow-2xl
                transform scale-95 transition">

        <div class="bg-gradient-to-r from-emerald-600 to-teal-600 px-6 py-4
                    flex items-center justify-between">
            <h3 id="modalTitle" class="text-white font-bold text-lg"></h3>
            <button onclick="closeModal()" class="text-white text-2xl">&times;</button>
        </div>

        <form id="appointmentForm" class="p-6 space-y-5 bg-slate-50">
            {% csrf_token %}

            <select id="id_user" name="user" class="w-full px-4 py-3 rounded-xl border">
                <option value="">Select candidate</option>
                {% for user in users %}
                <option value="{{ user.id }}">{{ user.username }}</option>
                {% endfor %}
            </select>

            <input type="datetime-local" id="id_scheduled_at" name="scheduled_at"
                   class="w-full px-4 py-3 rounded-xl border">

            <textarea id="id_notes" name="notes" rows="3"
                      class="w-full px-4 py-3 rounded-xl border"
                      placeholder="Notes (optional)"></textarea>

            <div class="flex justify-end">
                <button type="submit"
                        class="bg-gradient-to-r from-emerald-600 to-teal-600
                               text-white px-6 py-3 rounded-xl font-semibold shadow">
                    Save
                </button>
            </div>
        </form>
    </div>
</div>

<!-- New Modal for View Interview Details -->
<div id="viewModal"
     class="hidden fixed inset-0 bg-black/40 backdrop-blur-sm z-50
            flex items-center justify-center">
    <div class="bg-white w-full max-w-lg mx-4 rounded-2xl shadow-2xl transform scale-95 transition">
        <div class="bg-gradient-to-r from-gray-600 to-slate-600 px-6 py-4 flex items-center justify-between">
            <h3 class="text-white font-bold text-lg">Session Details</h3>
            <button onclick="closeViewModal()" class="text-white text-2xl">&times;</button>
        </div>
        <div id="viewContent" class="p-6 space-y-5 bg-slate-50">
            <!-- Content will be populated via JS -->
        </div>
    </div>
</div>

<!-- JS -->
<script>
const modal = document.getElementById('appointmentModal');
const form = document.getElementById('appointmentForm');
const viewModal = document.getElementById('viewModal');

function openCreateModal(){
    modal.classList.remove('hidden');
    form.action = "{% url 'appointment_create_one_on_one' %}";
    document.getElementById('modalTitle').innerText = "Create 1-1 Session";
}

function openEditModal(id){
    modal.classList.remove('hidden');
    form.action = "{% url 'appointment_edit' 0 %}".replace('0', id);
    document.getElementById('modalTitle').innerText = "Edit 1-1 Session";
}

function openPostponeModal(id){
    modal.classList.remove('hidden');
    form.action = "{% url 'appointment_postpone' 0 %}".replace('0', id);
    document.getElementById('modalTitle').innerText = "Postpone Session";
}

function closeModal(){
    modal.classList.add('hidden');
}

function openViewModal(id){
    viewModal.classList.remove('hidden');
    console.log('Opening view modal for ID:', id);  // Debug log
    // Fetch and populate details
    fetch("{% url 'appointment_view' 0 %}".replace('0', id), {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => {
        console.log('Response status:', response.status);  // Debug log
        console.log('Response headers:', response.headers.get('content-type'));  // Debug log
        if (!response.ok) {
            return response.text().then(text => {
                console.error('Response text (HTML):', text);  // Log the HTML response
                throw new Error(`Server error: ${response.status} - ${text}`);
            });
        }
        const contentType = response.headers.get('content-type');
        if (contentType && contentType.includes('application/json')) {
            return response.json();
        } else {
            throw new Error('Expected JSON response, but got HTML or other content. Check permissions or appointment ID.');
        }
    })
    .then(data => {
        console.log('Received data:', data);  // Debug log
        document.getElementById('viewContent').innerHTML = `
            <p><strong>Candidate:</strong> ${data.candidate}</p>
            <p><strong>Date & Time:</strong> ${data.scheduled_at}</p>
            <p><strong>Status:</strong> ${data.status}</p>
            <p><strong>Notes:</strong> ${data.notes || 'N/A'}</p>
        `;
    })
    .catch(error => {
        console.error('Fetch error:', error);
        document.getElementById('viewContent').innerHTML = `<p>Error loading details: ${error.message}. Please check your permissions or try again.</p>`;
    });
}

function closeViewModal(){
    viewModal.classList.add('hidden');
}

// Handle appointment form submit via AJAX with error handling
form.addEventListener('submit', function(e) {
    e.preventDefault();
    closeModal();  // Close modal immediately on submit
    const formData = new FormData(form);
    formData.append('X-Requested-With', 'XMLHttpRequest');

    fetch(form.action, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => {
        if (!response.ok) {
            return response.text().then(text => {
                throw new Error(`Server error: ${response.status} - ${text}`);
            });
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            location.reload();  // Reload to update the table on success
        } else {
            console.error('Form errors:', data.errors);  // Log errors to console instead of alert
        }
    })
    .catch(error => {
        console.error('Fetch error:', error);  // Log error to console instead of alert
    });
});

// Filters
const searchInput = document.getElementById('searchInput');
const statusFilter = document.getElementById('statusFilter');

function filterRows(){
    document.querySelectorAll('.appointment-row').forEach(row => {
        const name = row.children[0].innerText.toLowerCase();
        const status = row.dataset.status;
        row.style.display =
            name.includes(searchInput.value.toLowerCase()) &&
            (!statusFilter.value || status === statusFilter.value)
            ? '' : 'none';
    });
}

searchInput.addEventListener('input', filterRows);
statusFilter.addEventListener('change', filterRows);
document.getElementById('clearFilters').onclick = () => {
    searchInput.value = '';
    statusFilter.value = '';
    filterRows();
};

// New function for direct "Mark as Done" (no modal)
function markAsDone(id) {
    fetch("{% url 'mark_done_with_feedback' 0 %}".replace('0', id), {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => {
        if (!response.ok) {
            return response.text().then(text => {
                throw new Error(`Server error: ${response.status} - ${text}`);
            });
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            location.reload();  // Reload to update the table and show "View"
        } else {
            console.error('Failed to mark as done:', data);  // Log to console instead of alert
        }
    })
    .catch(error => {
        console.error('Fetch error:', error);  // Log to console instead of alert
    });
}
</script>

{% endblock %}
{% extends 'base.html' %}
{% block content %}
<h2 class="text-2xl font-bold mb-4">Candidate Chat</h2>

<div id="chat-box" class="border p-4 h-64 overflow-y-scroll mb-4 bg-gray-50">
    {% for chat in chats %}
        <p><strong>You:</strong> {{ chat.question|safe }}</p>
        <p><strong>Bot:</strong> {{ chat.answer|linebreaks|safe }}</p>
        <hr class="my-2">
    {% endfor %}
</div>

<div class="flex mb-4">
    <input type="text" id="chat-input" placeholder="Ask a question..." class="border p-2 flex-1 mr-2">
    <button id="send-btn" class="bg-blue-500 text-white px-4 py-2 rounded">Send</button>
    <button id="clear-btn" class="bg-red-500 text-white px-4 py-2 rounded ml-2">Clear Chat</button>
</div>

<div class="mb-4">
    <h4 class="font-semibold">Coding Questions:</h4>
    <ul>
        {% for s in coding_suggestions %}
            <li class="suggestion cursor-pointer text-blue-700">{{ s.question }}</li>
        {% endfor %}
    </ul>
</div>

<div class="mb-4">
    <h4 class="font-semibold">HR Questions:</h4>
    <ul>
        {% for s in hr_suggestions %}
            <li class="suggestion cursor-pointer text-blue-700">{{ s.question }}</li>
        {% endfor %}
    </ul>
</div>

<div class="mb-4">
    <h4 class="font-semibold">Behavioral Questions:</h4>
    <ul>
        {% for s in behavioral_suggestions %}
            <li class="suggestion cursor-pointer text-blue-700">{{ s.question }}</li>
        {% endfor %}
    </ul>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function(){
    // Send message
    $('#send-btn').click(function(){
        let question = $('#chat-input').val();
        if(question.trim() === '') return;
        $.ajax({
            url: "{% url 'send_message' %}",
            method: "POST",
            data: {
                'question': question,
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function(data){
                if(data.error) return;
                $('#chat-box').append('<p><strong>You:</strong> ' + data.question + '</p>');
                $('#chat-box').append('<p><strong>Bot:</strong> ' + data.answer + '</p><hr>');
                $('#chat-input').val('');
                $('#chat-box').scrollTop($('#chat-box')[0].scrollHeight);
            }
        });
    });

    // Clear chat
    $('#clear-btn').click(function(){
        if(confirm("Are you sure you want to clear all chat history?")){
            $.ajax({
                url: "{% url 'clear_chat' %}",
                method: "POST",
                data: {'csrfmiddlewaretoken': '{{ csrf_token }}'},
                success: function(data){
                    if(data.success){
                        $('#chat-box').html('');
                        alert('Chat history cleared.');
                    }
                }
            });
        }
    });

    // Click suggestion to input
    $('.suggestion').click(function(){
        $('#chat-input').val($(this).text());
    });

    // Filter suggestions dynamically as typing
    $('#chat-input').on('input', function(){
        let input = $(this).val().toLowerCase();
        $('.suggestion').each(function(){
            if($(this).text().toLowerCase().includes(input)){
                $(this).show();
            } else {
                $(this).hide();
            }
        });
    });
});
</script>
{% endblock %}
